name: Build Release

on:
  workflow_dispatch:
    inputs:
      platform:
        description: '选择构建平台'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - macos
          - windows
          - android
      # 品牌配置参数
      brand_app_name:
        description: '应用名称（英文，用于 exe/app 文件名）'
        required: true
        type: string
      brand_display_name:
        description: '显示名称（可中文，用于界面显示）'
        required: true
        type: string
      brand_package_name:
        description: '包名中间部分（英文小写，如填 abc 则包名为 com.abc.clash）'
        required: true
        type: string
      brand_oss_urls:
        description: 'OSS 配置地址（多个用逗号分隔）'
        required: true
        type: string
      # Bot 回调参数（可选，Bot 触发时填写）
      build_id:
        description: '打包任务 ID（Bot 触发时自动填写）'
        required: false
        type: string
      callback_url:
        description: '回调地址（Bot 触发时自动填写）'
        required: false
        type: string

jobs:
  build-macos:
    if: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'macos' }}
    runs-on: macos-14
    outputs:
      file_name: ${{ steps.build.outputs.file_name }}
      file_size: ${{ steps.build.outputs.file_size }}
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: PangHu-Code/client
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: main
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: core/go.sum

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Set brand variables
        id: brand
        run: |
          echo "app_name=${{ github.event.inputs.brand_display_name }}" >> $GITHUB_OUTPUT
          echo "package_id=com.${{ github.event.inputs.brand_package_name }}.clash" >> $GITHUB_OUTPUT

      - name: Build Core (macOS arm64)
        run: |
          cd core
          mkdir -p ../libclash/macos
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags="-w -s" -tags="with_gvisor" -o ../libclash/macos/FlClashCore

      - name: Apply brand config
        env:
          BRAND_APP_NAME: ${{ github.event.inputs.brand_app_name }}
          BRAND_DISPLAY_NAME: ${{ github.event.inputs.brand_display_name }}
          BRAND_PACKAGE_ID: com.${{ github.event.inputs.brand_package_name }}.clash
          BRAND_OSS_URLS: ${{ github.event.inputs.brand_oss_urls }}
        run: dart scripts/apply_brand.dart

      - name: Install dependencies
        run: flutter pub get

      - name: Build macOS
        run: flutter build macos --release --dart-define=APP_ENV=stable

      - name: Create ZIP and get info
        id: build
        run: |
          cd build/macos/Build/Products/Release
          FILE_NAME="${{ steps.brand.outputs.app_name }}-macos.zip"
          zip -r "$FILE_NAME" "${{ steps.brand.outputs.app_name }}.app"
          FILE_SIZE=$(stat -f%z "$FILE_NAME")
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
          echo "file_size=$FILE_SIZE" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: build/macos/Build/Products/Release/${{ steps.build.outputs.file_name }}

  build-windows:
    if: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'windows' }}
    runs-on: windows-latest
    outputs:
      file_name: ${{ steps.build.outputs.file_name }}
      file_size: ${{ steps.build.outputs.file_size }}
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: PangHu-Code/client
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: main
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: core/go.sum

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Set brand variables
        id: brand
        shell: bash
        run: |
          echo "app_name=${{ github.event.inputs.brand_display_name }}" >> $GITHUB_OUTPUT
          echo "package_id=com.${{ github.event.inputs.brand_package_name }}.clash" >> $GITHUB_OUTPUT

      - name: Build Core (Windows amd64)
        shell: bash
        run: |
          cd core
          mkdir -p ../libclash/windows
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags="-w -s" -tags="with_gvisor" -o ../libclash/windows/FlClashCore.exe

      - name: Build Helper Service
        shell: bash
        run: |
          CORE_SHA256=$(sha256sum libclash/windows/FlClashCore.exe | cut -d ' ' -f1)
          echo "Core SHA256: $CORE_SHA256"
          cd services/helper
          TOKEN=$CORE_SHA256 cargo build --release --features windows-service
          cp target/release/helper.exe ../../libclash/windows/FlClashHelperService.exe

      - name: Apply brand config
        env:
          BRAND_APP_NAME: ${{ github.event.inputs.brand_app_name }}
          BRAND_DISPLAY_NAME: ${{ github.event.inputs.brand_display_name }}
          BRAND_PACKAGE_ID: com.${{ github.event.inputs.brand_package_name }}.clash
          BRAND_OSS_URLS: ${{ github.event.inputs.brand_oss_urls }}
        run: dart scripts/apply_brand.dart

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows --release --dart-define=APP_ENV=stable

      - name: Create ZIP and get info
        id: build
        shell: pwsh
        run: |
          $FILE_NAME = "${{ steps.brand.outputs.app_name }}-windows.zip"
          Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath $FILE_NAME
          $FILE_SIZE = (Get-Item $FILE_NAME).Length
          echo "file_name=$FILE_NAME" >> $env:GITHUB_OUTPUT
          echo "file_size=$FILE_SIZE" >> $env:GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: ${{ steps.build.outputs.file_name }}

  build-android:
    if: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'android' }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      file_name: ${{ steps.build.outputs.file_name }}
      file_size: ${{ steps.build.outputs.file_size }}
    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: false
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: PangHu-Code/client
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: main
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: core/go.sum

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r28
          add-to-path: true
          link-to-sdk: true

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Set brand variables
        id: brand
        run: |
          echo "app_name=${{ github.event.inputs.brand_display_name }}" >> $GITHUB_OUTPUT
          echo "package_id=com.${{ github.event.inputs.brand_package_name }}.clash" >> $GITHUB_OUTPUT

      - name: Build Core (Android arm64-v8a)
        env:
          ANDROID_NDK: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          cd core
          mkdir -p ../libclash/android/arm64-v8a
          TOOLCHAIN=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64
          CC=$TOOLCHAIN/bin/aarch64-linux-android21-clang
          CGO_ENABLED=1 GOOS=android GOARCH=arm64 CC=$CC \
            go build -ldflags="-w -s" -tags="with_gvisor" -buildmode=c-shared \
            -o ../libclash/android/arm64-v8a/libclash.so
          mkdir -p ../libclash/android/includes/arm64-v8a
          cp ../libclash/android/arm64-v8a/libclash.h ../libclash/android/includes/arm64-v8a/ 2>/dev/null || true
          cp bride.h ../libclash/android/includes/arm64-v8a/ 2>/dev/null || true
          rm -f ../libclash/android/arm64-v8a/*.h 2>/dev/null || true

      - name: Apply brand config
        env:
          BRAND_APP_NAME: ${{ github.event.inputs.brand_app_name }}
          BRAND_DISPLAY_NAME: ${{ github.event.inputs.brand_display_name }}
          BRAND_PACKAGE_ID: com.${{ github.event.inputs.brand_package_name }}.clash
          BRAND_OSS_URLS: ${{ github.event.inputs.brand_oss_urls }}
        run: dart scripts/apply_brand.dart

      - name: Setup Android signing
        run: |
          echo "storePassword=panghu123456" >> android/local.properties
          echo "keyAlias=release" >> android/local.properties
          echo "keyPassword=panghu123456" >> android/local.properties

      - name: Install dependencies
        run: flutter pub get

      - name: Build APK
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2 -Dorg.gradle.jvmargs=-Xmx4g"
        run: |
          ls -la libclash/android/arm64-v8a/
          flutter build apk --release --dart-define=APP_ENV=stable

      - name: Rename APK and get info
        id: build
        run: |
          FILE_NAME="${{ steps.brand.outputs.app_name }}-android.apk"
          mv build/app/outputs/flutter-apk/app-release.apk "$FILE_NAME"
          FILE_SIZE=$(stat -c%s "$FILE_NAME")
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
          echo "file_size=$FILE_SIZE" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: ${{ steps.build.outputs.file_name }}

  # 汇总并回调（仅当 Bot 触发时执行）
  callback:
    needs: [build-macos, build-windows, build-android]
    # 即使部分平台跳过或失败也要执行回调
    if: ${{ always() && github.event.inputs.build_id != '' && github.event.inputs.callback_url != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload to R2 and callback
        env:
          BUILD_ID: ${{ github.event.inputs.build_id }}
          CALLBACK_URL: ${{ github.event.inputs.callback_url }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
          R2_UPLOAD_URL: ${{ secrets.R2_UPLOAD_URL }}
          PLATFORM: ${{ github.event.inputs.platform }}
          MACOS_RESULT: ${{ needs.build-macos.result }}
          MACOS_FILE_NAME: ${{ needs.build-macos.outputs.file_name }}
          MACOS_FILE_SIZE: ${{ needs.build-macos.outputs.file_size }}
          WINDOWS_RESULT: ${{ needs.build-windows.result }}
          WINDOWS_FILE_NAME: ${{ needs.build-windows.outputs.file_name }}
          WINDOWS_FILE_SIZE: ${{ needs.build-windows.outputs.file_size }}
          ANDROID_RESULT: ${{ needs.build-android.result }}
          ANDROID_FILE_NAME: ${{ needs.build-android.outputs.file_name }}
          ANDROID_FILE_SIZE: ${{ needs.build-android.outputs.file_size }}
        run: |
          echo "Checking build results..."

          # 收集成功的构建产物
          ARTIFACTS='[]'
          ERROR_MESSAGE=""
          HAS_SUCCESS=false

          # 检查 macOS
          if [ "$PLATFORM" == "all" ] || [ "$PLATFORM" == "macos" ]; then
            if [ "$MACOS_RESULT" == "success" ] && [ -f "artifacts/macos-build/$MACOS_FILE_NAME" ]; then
              echo "Uploading macOS build..."
              FILE_KEY="$BUILD_ID/macos/$MACOS_FILE_NAME"
              curl -X POST "$R2_UPLOAD_URL/$FILE_KEY" \
                -H "Authorization: Bearer $WEBHOOK_SECRET" \
                -H "Content-Type: application/octet-stream" \
                --data-binary "@artifacts/macos-build/$MACOS_FILE_NAME"
              ARTIFACTS=$(echo "$ARTIFACTS" | jq --arg platform "macos" --arg file_key "$FILE_KEY" --arg file_size "$MACOS_FILE_SIZE" \
                '. + [{"platform": $platform, "file_key": $file_key, "file_size": ($file_size | tonumber)}]')
              HAS_SUCCESS=true
            else
              ERROR_MESSAGE="${ERROR_MESSAGE}macOS 构建失败; "
            fi
          fi

          # 检查 Windows
          if [ "$PLATFORM" == "all" ] || [ "$PLATFORM" == "windows" ]; then
            if [ "$WINDOWS_RESULT" == "success" ] && [ -f "artifacts/windows-build/$WINDOWS_FILE_NAME" ]; then
              echo "Uploading Windows build..."
              FILE_KEY="$BUILD_ID/windows/$WINDOWS_FILE_NAME"
              curl -X POST "$R2_UPLOAD_URL/$FILE_KEY" \
                -H "Authorization: Bearer $WEBHOOK_SECRET" \
                -H "Content-Type: application/octet-stream" \
                --data-binary "@artifacts/windows-build/$WINDOWS_FILE_NAME"
              ARTIFACTS=$(echo "$ARTIFACTS" | jq --arg platform "windows" --arg file_key "$FILE_KEY" --arg file_size "$WINDOWS_FILE_SIZE" \
                '. + [{"platform": $platform, "file_key": $file_key, "file_size": ($file_size | tonumber)}]')
              HAS_SUCCESS=true
            else
              ERROR_MESSAGE="${ERROR_MESSAGE}Windows 构建失败; "
            fi
          fi

          # 检查 Android
          if [ "$PLATFORM" == "all" ] || [ "$PLATFORM" == "android" ]; then
            if [ "$ANDROID_RESULT" == "success" ] && [ -f "artifacts/android-build/$ANDROID_FILE_NAME" ]; then
              echo "Uploading Android build..."
              FILE_KEY="$BUILD_ID/android/$ANDROID_FILE_NAME"
              curl -X POST "$R2_UPLOAD_URL/$FILE_KEY" \
                -H "Authorization: Bearer $WEBHOOK_SECRET" \
                -H "Content-Type: application/octet-stream" \
                --data-binary "@artifacts/android-build/$ANDROID_FILE_NAME"
              ARTIFACTS=$(echo "$ARTIFACTS" | jq --arg platform "android" --arg file_key "$FILE_KEY" --arg file_size "$ANDROID_FILE_SIZE" \
                '. + [{"platform": $platform, "file_key": $file_key, "file_size": ($file_size | tonumber)}]')
              HAS_SUCCESS=true
            else
              ERROR_MESSAGE="${ERROR_MESSAGE}Android 构建失败; "
            fi
          fi

          # 发送回调
          if [ "$HAS_SUCCESS" == "true" ]; then
            echo "Sending success callback..."
            curl -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "X-GitHub-Event: repository_dispatch" \
              -H "X-Hub-Signature-256: $(echo -n "{\"action\":\"build_complete\",\"client_payload\":{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"artifacts\":$ARTIFACTS}}" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | sed 's/^.* /sha256=/')" \
              -d "{\"action\":\"build_complete\",\"client_payload\":{\"build_id\":\"$BUILD_ID\",\"status\":\"success\",\"artifacts\":$ARTIFACTS}}"
          else
            echo "Sending failure callback..."
            curl -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "X-GitHub-Event: repository_dispatch" \
              -H "X-Hub-Signature-256: $(echo -n "{\"action\":\"build_complete\",\"client_payload\":{\"build_id\":\"$BUILD_ID\",\"status\":\"failed\",\"error_message\":\"$ERROR_MESSAGE\"}}" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | sed 's/^.* /sha256=/')" \
              -d "{\"action\":\"build_complete\",\"client_payload\":{\"build_id\":\"$BUILD_ID\",\"status\":\"failed\",\"error_message\":\"$ERROR_MESSAGE\"}}"
          fi
